<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProFitness</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .login-card { width: 400px; padding: 30px; background: white; border-radius: 15px; }
        #dashboard-screen, #admin-screen { display: none; padding: 20px; }
        .card { margin-bottom: 20px; transition: 0.3s; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-5px); }
        .price-tag { font-size: 1.5rem; font-weight: bold; color: #28a745; }
        .time-selector.active { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>
    <!-- GÄ°RÄ°Åž -->
    <div id="login-screen">
        <div class="login-card text-center">
            <h2 class="mb-4"><i class="fas fa-dumbbell text-primary"></i> ProFitness</h2>
            <input type="text" id="loginId" class="form-control mb-3" placeholder="Ãœye ID veya 'admin'">
            <div class="form-check form-switch mb-3 text-start">
                <input class="form-check-input" type="checkbox" id="loginStudentCheck">
                <label class="form-check-label" for="loginStudentCheck">Ã–ÄŸrenciyim (%50 Ä°ndirim)</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100">GiriÅŸ Yap</button>
        </div>
    </div>

    <!-- ÃœYE PANELÄ° -->
    <div id="dashboard-screen">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Merhaba, Ãœye <span id="displayId"></span></h3>
                <button onclick="logout()" class="btn btn-danger btn-sm">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            <div class="card p-3">
                <h5>ðŸ“… RezervasyonlarÄ±m</h5>
                <ul id="my-list" class="list-group list-group-flush"><li class="list-group-item">YÃ¼kleniyor...</li></ul>
            </div>
            <h4 class="mt-4">MÃ¼sait Dersler</h4>
            <div id="classes-container" class="row"></div>
        </div>
    </div>

    <!-- ADMIN PANELÄ° -->
    <div id="admin-screen">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-danger"><i class="fas fa-user-shield"></i> YÃ¶netici Paneli</h2>
                <button onclick="logout()" class="btn btn-dark btn-sm">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h5>ðŸ“‹ Aktif Rezervasyon Listesi</h5>
                    <button onclick="loadAdminData()" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> Yenile</button>
                </div>
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr><th>Ãœye ID</th><th>Ãœyelik</th><th>Ders</th><th>Saat</th><th>Ä°ÅŸlem</th></tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let currentUser = { id: null, isStudent: false };
        let allGroups = {};

        async function login() {
            const inputVal = document.getElementById('loginId').value;
            const studentCheck = document.getElementById('loginStudentCheck').checked;
            if(!inputVal) return Swal.fire('Hata', 'GiriÅŸ yapÄ±nÄ±z', 'warning');

            // ADMIN
            if (inputVal.toLowerCase() === 'admin') {
                const { value: password } = await Swal.fire({ title: 'YÃ¶netici GiriÅŸi', input: 'password', inputPlaceholder: 'Åžifre', confirmButtonText: 'GiriÅŸ', showCancelButton: true });
                if (password === 'admin') {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('admin-screen').style.display = 'block';
                    loadAdminData();
                } else if (password) Swal.fire('Hata', 'YanlÄ±ÅŸ Åžifre!', 'error');
                return;
            }

            // USER CHECK
            try {
                const requestedType = studentCheck ? 'student' : 'standard';
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: parseInt(inputVal), type: requestedType }) });
                const data = await res.json();
                if (data.status === 'warning') await Swal.fire({ icon: 'info', title: 'Bilgilendirme', text: data.message, confirmButtonText: 'Tamam' });

                currentUser.id = parseInt(inputVal);
                currentUser.isStudent = (data.actual_type === 'student');
                const typeText = currentUser.isStudent ? ' (Ã–ÄŸrenci)' : '';
                document.getElementById('displayId').innerText = currentUser.id + typeText;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                fetchClasses(); fetchMyReservations();
            } catch (err) { Swal.fire('Hata', 'Sunucu hatasÄ±', 'error'); }
        }

        function logout() { location.reload(); }

        // --- ADMIN ---
        async function loadAdminData() {
            try {
                const res = await fetch('/api/admin/all'); const data = await res.json();
                const tbody = document.getElementById('admin-table-body'); tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Åžu an hiÃ§ rezervasyon yok.</td></tr>';
                    return;
                }
                
                data.forEach(row => {
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="badge bg-secondary" style="font-size: 1em;">${row.member_id}</span></td>
                            <td>${row.type === 'Ã–ÄŸrenci' ? '<span class="badge bg-info text-dark">Ã–ÄŸrenci</span>' : '<span class="badge bg-light text-dark border">Standart</span>'}</td>
                            <td><b>${row.class_title}</b></td>
                            <td>${row.class_time}</td>
                            <td>
                                <button onclick="adminCancel(${row.member_id}, ${row.class_id})" class="btn btn-sm btn-danger shadow-sm">
                                    <i class="fas fa-trash-alt"></i> Ä°ptal Et
                                </button>
                            </td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }
        async function adminCancel(mid, cid) { cancelReservation(mid, cid, true); }

        // --- USER ---
        async function fetchClasses() {
            try { const res = await fetch(`/api/classes?student=${currentUser.isStudent}&member_id=${currentUser.id}`); const data = await res.json(); groupAndRender(data.classes); } catch (e) { console.error(e); }
        }
        async function fetchMyReservations() {
            try { const res = await fetch(`/api/members/${currentUser.id}/reservations`); const data = await res.json(); renderMyList(data.reservations); } catch (e) { console.error(e); }
        }
        function renderMyList(list) {
            const ul = document.getElementById('my-list'); ul.innerHTML = '';
            if(list.length === 0) ul.innerHTML = '<li class="list-group-item text-muted">Rezervasyon yok.</li>';
            list.forEach(c => {
                ul.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span><b>${c.title}</b> (${c.time})</span> <button onclick="cancelReservation(${currentUser.id}, ${c.class_id})" class="btn btn-sm btn-outline-danger">Ä°ptal</button></li>`;
            });
        }
        function groupAndRender(classes) {
            allGroups = {}; classes.forEach(c => { if (!allGroups[c.title]) allGroups[c.title] = []; allGroups[c.title].push(c); });
            const div = document.getElementById('classes-container'); div.innerHTML = '';
            for (const [title, sessions] of Object.entries(allGroups)) {
                sessions.sort((a,b) => a.time.localeCompare(b.time));
                const instructor = sessions[0].instructor;
                let btns = ''; const first = sessions[0];
                sessions.forEach((s, i) => {
                    let cls = s.occupancy >= s.capacity ? 'btn-outline-secondary disabled' : 'btn-outline-primary';
                    let active = i === 0 ? 'active' : '';
                    btns += `<button class="btn ${cls} ${active} btn-sm me-2 mb-2 ts" onclick="select(this, ${s.id})">${s.time}</button>`;
                });
                div.innerHTML += `<div class="col-md-6 mb-4"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-2"><h5 class="card-title fw-bold mb-0">${title}</h5><span class="badge bg-light text-dark">${instructor}</span></div><p class="text-muted small">Seans SeÃ§iniz:</p><div id="btns-${first.id}">${btns}</div><div id="info-${first.id}" class="info-box p-3 bg-light rounded mt-3">${renderInfo(first)}</div></div></div></div>`;
            }
        }
        function select(btn, cid) {
            const parent = btn.parentElement;
            for(let b of parent.getElementsByClassName('ts')) b.classList.remove('active');
            btn.classList.add('active');
            let session = null;
            for(const group of Object.values(allGroups)) { const found = group.find(s => s.id === cid); if(found) { session = found; break; } }
            parent.nextElementSibling.innerHTML = renderInfo(session);
        }
        function renderInfo(c) {
            const pct = (c.occupancy / c.capacity) * 100;
            let bar = pct >= 80 ? 'bg-warning' : 'bg-success';
            let btnTxt = 'Rezervasyon Yap'; let dis = '';
            if(pct >= 100) { bar = 'bg-danger'; btnTxt = 'DOLU'; dis = 'disabled'; }
            return `<div class="d-flex justify-content-between small mb-1"><span>Doluluk</span><span>${c.occupancy}/${c.capacity}</span></div><div class="progress mb-3" style="height: 6px;"><div class="progress-bar ${bar}" style="width: ${pct}%"></div></div><div class="text-center mb-3"><div class="price-tag">${c.final_price} TL</div></div><button onclick="book(${c.id})" class="btn btn-primary w-100 fw-bold" ${dis}>${btnTxt}</button>`;
        }
        async function book(cid) {
            const payload = { member_id: currentUser.id, class_id: cid, membership_type: currentUser.isStudent ? 'student' : 'standard' };
            try { const res = await fetch('/api/reservations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const d = await res.json(); if (res.ok) { Swal.fire('SÃ¼per', d.message, 'success'); fetchClasses(); fetchMyReservations(); } else Swal.fire('Hata', d.error, 'error'); } catch (e) { Swal.fire('Hata', 'Sunucu hatasÄ±', 'error'); }
        }
        async function cancelReservation(mid, cid, isAdmin = false) {
            const c = await Swal.fire({ title: 'Ä°ptal?', icon: 'warning', showCancelButton: true, confirmButtonText:'Evet' });
            if(!c.isConfirmed) return;
            const res = await fetch('/api/reservations', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ member_id: mid, class_id: cid }) });
            if(res.ok) { Swal.fire('Silindi', '', 'success'); if (isAdmin) loadAdminData(); else { fetchClasses(); fetchMyReservations(); } } else { Swal.fire('Hata', 'Silinemedi', 'error'); }
        }
    </script>
</body>
</html>